(function(e){function t(t){for(var o,n,s=t[0],c=t[1],d=t[2],h=0,u=[];h<s.length;h++)n=s[h],Object.prototype.hasOwnProperty.call(a,n)&&a[n]&&u.push(a[n][0]),a[n]=0;for(o in c)Object.prototype.hasOwnProperty.call(c,o)&&(e[o]=c[o]);l&&l(t);while(u.length)u.shift()();return r.push.apply(r,d||[]),i()}function i(){for(var e,t=0;t<r.length;t++){for(var i=r[t],o=!0,s=1;s<i.length;s++){var c=i[s];0!==a[c]&&(o=!1)}o&&(r.splice(t--,1),e=n(n.s=i[0]))}return e}var o={},a={app:0},r=[];function n(t){if(o[t])return o[t].exports;var i=o[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=o,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(i,o,function(t){return e[t]}.bind(null,o));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="";var s=window["webpackJsonp"]=window["webpackJsonp"]||[],c=s.push.bind(s);s.push=t,s=s.slice();for(var d=0;d<s.length;d++)t(s[d]);var l=c;r.push([0,"chunk-vendors"]),i()})({0:function(e,t,i){e.exports=i("56d7")},"01f3":function(e,t){function i(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}i.keys=function(){return[]},i.resolve=i,e.exports=i,i.id="01f3"},"034f":function(e,t,i){"use strict";i("85ec")},"1fe1":function(e,t,i){"use strict";i("58f1")},"56d7":function(e,t,i){"use strict";i.r(t);var o=i("a026"),a=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{attrs:{id:"app"}},[i("router-view",{key:e.$route.fullPath})],1)},r=[],n=(i("034f"),i("2877")),s={},c=Object(n["a"])(s,a,r,!1,null,null,null),d=c.exports,l=i("8c4f"),h=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",[e._v(" "+e._s(e.tipText)+" "),i("div",{directives:[{name:"show",rawName:"v-show",value:e.cameraWork,expression:"cameraWork"}],staticClass:"div"},[i("div",{staticClass:"box see"},[i("video",{ref:"myVideo",attrs:{id:"myVideo",muted:"",loop:"",playsinline:"","webkit-playsinline":"","x5-playsinline":""},domProps:{muted:!0},on:{loadedmetadata:e.fnRun}}),i("canvas",{ref:"myCanvas",attrs:{id:"myCanvas"}}),i("canvas",{ref:"myCircle",attrs:{id:"myCircle",width:"300",height:"400"}}),i("canvas",{ref:"myStep",attrs:{id:"myStep",width:"300",height:"400"}})]),i("canvas",{ref:"myPhoto",staticClass:"my-photo",attrs:{id:"myPhoto",width:"300",height:"400"}})]),i("div",[i("button",{on:{click:e.fnOpen}},[e._v("开始识别1")])]),i("div",[e._v("err1:"+e._s(e.err1))]),i("div",[e._v("err2:"+e._s(e.err2))]),i("div",[e._v("vEl:"+e._s(e.videoEl))]),i("div",[e._v("cEl:"+e._s(e.canvasEl))])])},u=[],v=i("75bf");let f,p=3,m=330,g=5,w=[],x=[],y=.9,b=3,T=8,E=0;var k={data(){return{fileLoading:!1,mediaDevice:!1,nets:"tinyFaceDetector",options:null,withBoxes:!0,detectFace:"detectAllFaces",detection:"landmark",videoEl:null,canvasEl:null,timeout:0,constraints:{audio:!1,video:{width:{ideal:400},height:{ideal:300},frameRate:{ideal:30},facingMode:"user"}},faceScore:0,faceNum:0,tipText:"请确保正对手机，光线充足",photos:[],photoSleep:!1,cameraWork:!1,cameraLoading:!1,overtime:T,overtimer:null,currentDeg:0,stepEl:null,stepIndex:0,modelLoading:!1,dataLoading:!1,resultShow:!1,resultCode:4,buttonTime:p,demo:0,mediaChecking:!0,isAlipay:!1,videoSrc:"",agreement:!1,agreementShow:!1,agreementURL:"",compName:"",err1:"",err2:""}},mounted(){f=this,this.$nextTick(()=>{this.fnInit()})},destroy(){this.fnClose()},watch:{currentDeg(e){if(e>=m)return f.tipText="已完成",void setTimeout(()=>{f.fnClose()},100)},faceScore(e){if(f.photos.length>=b)clearInterval(f.overtimer);else switch(f.faceNum){case 0:if(!f.mediaDevice)break;f.tipText="请移动人脸到框内";break;case 1:f.mediaDevice&&(f.tipText=e>=y?"请保持姿势不变":"请正对手机，调整人脸与手机的距离"),e>=y&&!f.photoSleep&&f.photos.length<b&&(f.takePhoto(e),f.photoSleep=!0,setTimeout(()=>{f.photoSleep=!1},f.mediaDevice?Math.floor(501*Math.random()+300):100));break;default:if(!f.mediaDevice)break;f.tipText="请拍摄本人照片"}}},methods:{fnRun(){setTimeout(()=>{f.fnRunFaceLandmark()},300)},drawCircle(){let e=f.$refs.myCircle;f.stepEl=f.$refs.myStep;let t=300,i=400;window.devicePixelRatio&&(f.stepEl.style.width=e.style.width=t+"px",f.stepEl.style.height=e.style.height=i+"px",f.stepEl.height=e.height=i*window.devicePixelRatio,f.stepEl.width=e.width=t*window.devicePixelRatio,f.stepEl.getContext("2d").scale(window.devicePixelRatio,window.devicePixelRatio),e.getContext("2d").scale(window.devicePixelRatio,window.devicePixelRatio));let o=e.getContext("2d");o.fillStyle="#fff",o.arc(150,150,110,0,2*Math.PI,!1),o.arc(150,150,300,0,2*Math.PI,!0),o.fill(),f.drawStepRound()},drawStepRound(){let e=f.stepEl.getContext("2d");e.clearRect(0,0,f.stepEl.width,f.stepEl.height),e.beginPath(),e.lineWidth=4,e.strokeStyle="#ebebeb",e.lineCap="round",e.arc(150,150,114,Math.PI/180*(90+(360-m)/2),Math.PI/180*(450-(360-m)/2),!1),e.stroke()},colorToRgb(e){let t=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(e=e.toLowerCase(),e&&t.test(e)){if(4===e.length){let t="#";for(let i=1;i<4;i+=1)t+=e.slice(i,i+1).concat(e.slice(i,i+1));e=t}let t=[];for(let i=1;i<7;i+=2)t.push(parseInt("0x"+e.slice(i,i+2)));return t}return e},colorToHex(e){let t=e,i=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(/^(rgb|RGB)/.test(t)){let e=t.replace(/(?:\(|\)|rgb|RGB)*/g,"").split(","),i="#";for(let t=0;t<e.length;t++){let o=Number(e[t]).toString(16);o=o<10?"0"+o:o,"0"===o&&(o+=o),i+=o}return 7!==i.length&&(i=t),i}if(!i.test(t))return t;{let e=t.replace(/#/,"").split("");if(6===e.length)return t;if(3===e.length){let t="#";for(let i=0;i<e.length;i+=1)t+=e[i]+e[i];return t}}},getRandomRate(){let e=m%g?parseInt(m/g)+1:m/g;w=[];let t=0;for(let i=1;i<e;i++){let e=Math.floor(Math.random()*(g-2+1)+2);w.push(e),t+=e}w.push(m-t)},gradientColor(e,t,i){let o=f.colorToRgb(e),a=o[0],r=o[1],n=o[2],s=f.colorToRgb(t),c=s[0],d=s[1],l=s[2],h=(c-a)/i,u=(d-r)/i,v=(l-n)/i,p=[];for(let m=0;m<i;m++){let e=f.colorToHex("rgb("+parseInt(h*m+a)+","+parseInt(u*m+r)+","+parseInt(v*m+n)+")");p.push(e)}return p},async fnInit(){f.drawCircle(),x=f.gradientColor("#BFD9F3","#1989fa",m%g?parseInt(m/g)+1:m/g),f.getRandomRate();try{await v["nets"][f.nets].loadFromUri("./models")}catch(e){this.err1=e}try{await v["loadFaceLandmarkModel"]("./models")}catch(e){this.err2=e}f.options=new v["TinyFaceDetectorOptions"]({inputSize:224,scoreThreshold:.3}),f.videoEl=f.$refs.myVideo,f.canvasEl=f.$refs.myCanvas},async fnRunFaceLandmark(){if(f.videoEl.paused)return clearTimeout(f.timeout);const e=await v[f.detectFace](f.videoEl,f.options);e&&!f.videoEl.paused?(f.faceNum=e?e.length:0,f.faceScore=1===f.faceNum?e[0].score:0):f.canvasEl.getContext("2d").clearRect(0,0,f.canvasEl.width,f.canvasEl.height),f.timeout=setTimeout(()=>f.fnRunFaceLandmark(),150)},fnOpen(){"object"!==typeof window.stream&&(f.cameraLoading=!0,f.tipText="正在启动相机…",clearTimeout(f.timeout),f.timeout=setTimeout(()=>{navigator.mediaDevices.getUserMedia(f.constraints).then(f.fnSuccess).catch(f.fnError)},200))},fnSuccess(e){window.stream=e,f.videoEl.srcObject=e,f.videoEl.play(),setTimeout(()=>{f.cameraLoading=!1,f.cameraWork=!0,f.tipText="请移动人脸到框内"},100)},fnError(e){if(console.log(e.name),E++,f.cameraLoading=!1,E>2||"NotAllowedError"!=e.name)return alert("开启相机失败, 已切换至视频录制模式"),f.tipText="请确保正对手机，光线充足",f.mediaDevice=!1,void(f.resultCode=4);f.tipText="开启相机失败, 请重试",f.resultCode=2,f.resultShow=!0},fnClose(){f.canvasEl&&f.canvasEl.getContext("2d").clearRect(0,0,f.canvasEl.width,f.canvasEl.height),f.videoEl&&f.videoEl.pause(),f.cameraWork=!1,clearTimeout(f.timeout),"object"===typeof window.stream&&(window.stream.getTracks().forEach(e=>e.stop()),window.stream="",f.videoEl.srcObject=null)},takePhoto(e){let t=f.$refs.myPhoto,i=t.getContext("2d");i.drawImage(f.videoEl,0,0,f.videoEl.videoWidth,f.videoEl.videoHeight);let o=t.toDataURL("image/jpeg");f.photos.push({score:e,img:o})}}},C=k,F=(i("1fe1"),Object(n["a"])(C,h,u,!1,null,null,null)),S=F.exports,R=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",[i("div",{staticClass:"x-face-detect-modal"},[i("video",{ref:"video",staticStyle:{width:"300px",height:"300px"},attrs:{autoplay:""},on:{canplay:e.handleVideoCanPlay}}),i("canvas",{ref:"canvas",attrs:{width:e.width,height:e.height}}),i("img",{attrs:{src:e.imgSrc}}),i("button",{on:{click:e.toGetUserMedia}},[e._v("调用摄像头")])])])},P=[],M={name:"",data(){return{options:{},imgSrc:"",canPlay:"",canvas:"",video:"",stream:null,getUserMediaFail:"",width:300,height:300,boxWidth:300,boxHeight:300,viewFinderBox:{}}},created(){this.options=new v["TinyFaceDetectorOptions"]({scoreThreshold:.5})},mounted(){this.canvas=this.$refs["canvas"],this.video=this.$refs["video"],this.init(),this.$nextTick(()=>{this.initViewFinder()})},methods:{handleVideoCanPlay(){console.log("视频播放成功","handleVideoCanPlay"),this.canPlay=!0},async init(){await v["nets"].tinyFaceDetector.loadFromUri("../../public/models")},toGetUserMedia(){this.getUserMedia(e=>{this.stream=e,this.video&&(this.video["srcObject"]=e),console.log("获取视频成功",this.video["srcObject"])},e=>this.getUserMediaFail=!0)},getUserMedia(e,t){const i={video:{facingMode:"user",width:{ideal:this.width},height:{ideal:this.height}}};navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(i).then(e).catch(t):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(i,e,t):navigator.mozGetUserMedia?navigator.mozGetUserMedia(i,e,t):navigator.getUserMedia&&navigator.getUserMedia(i,e,t)},initViewFinder(){if(!this.video)return;const e=(this.video.videoWidth-this.boxWidth)/2,t=(this.video.videoHeight-this.boxHeight)/2;this.canvas&&(this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight),this.viewFinderBox={topLeft:{x:e,y:t},topRight:{x:e+this.boxWidth,y:t},bottomLeft:{x:e,y:t+this.boxHeight},bottomRight:{x:e+this.boxWidth,y:t+this.boxHeight}},console.log("初始化取景框",this.viewFinderBox)},drawViewFinder(){let e=null;this.canvas&&(e=this.canvas.getContext("2d"));const t=50;if(!e)return!1;e.clearRect(0,0,this.canvas?this.canvas.width:0,this.canvas?this.canvas.height:0);const i=this.video?(this.video.videoWidth-200)/2:200;e.font="20px Arial",e.fillText("请保持脸部在取景框内",i,50);const o=Object.keys(this.viewFinderBox);o.forEach(i=>{const o=this.viewFinderBox[i];if(o)switch(e.moveTo(o.x,o.y),i){case"topLeft":e.lineTo(o.x+t,o.y),e.moveTo(o.x,o.y),e.lineTo(o.x,o.y+t);break;case"topRight":e.lineTo(o.x-t,o.y),e.moveTo(o.x,o.y),e.lineTo(o.x,o.y+t);break;case"bottomLeft":e.lineTo(o.x+t,o.y),e.moveTo(o.x,o.y),e.lineTo(o.x,o.y-t);break;case"bottomRight":e.lineTo(o.x-t,o.y),e.moveTo(o.x,o.y),e.lineTo(o.x,o.y-t);break;default:break}}),e.lineWidth=2,e.strokeStyle="white",e.stroke()},delay(){for(let e=0;e<2e5;e++);return""},async detectFace(){if(await new Promise(e=>requestAnimationFrame(e)),this.drawViewFinder(),!this.canvas||!this.video||!this.video.currentTime||this.video.paused||this.video.ended)return this.detectFace();const e=await Object(v["detectSingleFace"])(this.video,this.options);if(!e)return this.detectFace();const t=Object(v["matchDimensions"])(this.canvas,this.video,!0),i=Object(v["resizeResults"])(e,t),o=i.box;if(!this.checkInViewFinder(o))return this.detectFace();this.drawViewFinder(),this.drawBox(o,"识别中"),this.video.pause();const a=await this.cameraShoot(this.video,i.box.topLeft,i.box.width,i.box.height);if(!a)return this.drawBox(o,"识别失败"),await delay(1e3),this.video.play(),this.detectFace();let r=new window.File([a],"人脸头像.jpeg",{type:"image/jpeg"});const n=await this.computedService.faceDetect(this.formId,r);if(!n)return this.drawBox(o,"识别失败"),await delay(1e3),this.video.play(),this.detectFace();this.handleStopVideo()},cameraShoot(e,t,i,o){const a=document.createElement("canvas");return a.width=e.videoWidth,a.height=e.videoHeight,a.getContext("2d")&&a.getContext("2d").drawImage(e,t.x-40,t.y-40,i+80,o+80,0,0,a.width,a.height),new Promise(e=>a.toBlob(e,"image/jpeg"))},drawBox(e,t){if(!this.canvas)return;const i=this.canvas.getContext("2d");i&&i.clearRect(e.x,e.y,e.width,e.height);const o=new v["draw"].DrawBox(e,{label:t});o.draw(this.canvas)},handleStopVideo(){this.stream&&this.stream.getTracks().forEach(e=>e.stop())}}},O=M,j=(i("61e5"),Object(n["a"])(O,R,P,!1,null,"c5c55d00",null)),_=j.exports,D=[{path:"/",name:"人脸提取",component:S},{path:"/two",name:"two",component:_}];o["a"].use(l["a"]);const U=new l["a"]({routes:D});U.beforeEach((e,t,i)=>{i()}),U.afterEach(()=>{window.scrollTo(0,0)});var L=U;o["a"].config.productionTip=!1,new o["a"]({router:L,render:e=>e(d)}).$mount("#app")},"58f1":function(e,t,i){},"61e5":function(e,t,i){"use strict";i("8fb2")},"85ec":function(e,t,i){},"8fb2":function(e,t,i){}});