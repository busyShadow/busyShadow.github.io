(function(e){function t(t){for(var o,r,s=t[0],c=t[1],d=t[2],h=0,u=[];h<s.length;h++)r=s[h],Object.prototype.hasOwnProperty.call(a,r)&&a[r]&&u.push(a[r][0]),a[r]=0;for(o in c)Object.prototype.hasOwnProperty.call(c,o)&&(e[o]=c[o]);l&&l(t);while(u.length)u.shift()();return n.push.apply(n,d||[]),i()}function i(){for(var e,t=0;t<n.length;t++){for(var i=n[t],o=!0,s=1;s<i.length;s++){var c=i[s];0!==a[c]&&(o=!1)}o&&(n.splice(t--,1),e=r(r.s=i[0]))}return e}var o={},a={app:0},n=[];function r(t){if(o[t])return o[t].exports;var i=o[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=o,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(i,o,function(t){return e[t]}.bind(null,o));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="";var s=window["webpackJsonp"]=window["webpackJsonp"]||[],c=s.push.bind(s);s.push=t,s=s.slice();for(var d=0;d<s.length;d++)t(s[d]);var l=c;n.push([0,"chunk-vendors"]),i()})({0:function(e,t,i){e.exports=i("56d7")},"01f3":function(e,t){function i(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}i.keys=function(){return[]},i.resolve=i,e.exports=i,i.id="01f3"},"034f":function(e,t,i){"use strict";i("85ec")},"1fe1":function(e,t,i){"use strict";i("58f1")},"56d7":function(e,t,i){"use strict";i.r(t);var o=i("a026"),a=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{attrs:{id:"app"}},[i("router-view",{key:e.$route.fullPath})],1)},n=[],r=(i("034f"),i("2877")),s={},c=Object(r["a"])(s,a,n,!1,null,null,null),d=c.exports,l=i("8c4f"),h=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",[e._v(" "+e._s(e.tipText)+" "),i("div",{staticClass:"div"},[i("div",{staticClass:"box see"},[i("video",{ref:"myVideo",attrs:{id:"myVideo",muted:"",loop:"",playsinline:"","webkit-playsinline":"","x5-playsinline":""},domProps:{muted:!0},on:{loadedmetadata:e.fnRun}}),i("canvas",{ref:"myCanvas",attrs:{id:"myCanvas"}}),i("canvas",{ref:"myCircle",attrs:{id:"myCircle",width:"300",height:"400"}}),i("canvas",{ref:"myStep",attrs:{id:"myStep",width:"300",height:"400"}})]),i("canvas",{ref:"myPhoto",staticClass:"my-photo",attrs:{id:"myPhoto",width:"300",height:"400"}})]),i("div",[i("button",{on:{click:e.fnOpen}},[e._v("开始识别1")])]),i("div",[e._v("err1:"+e._s(e.err1))]),i("div",[e._v("err2:"+e._s(e.err2))]),i("div",[e._v("vEl:"+e._s(e.videoEl))]),i("div",[e._v("cEl:"+e._s(e.canvasEl))])])},u=[],v=i("75bf"),f=i("3a34"),p=i.n(f);let m,g=3,w=330,x=5,y=[],b=[],T=.9,E=3,k=8,F=0;var C={data(){return{fileLoading:!1,mediaDevice:!1,nets:"tinyFaceDetector",options:null,withBoxes:!0,detectFace:"detectAllFaces",detection:"landmark",videoEl:null,canvasEl:null,timeout:0,constraints:{audio:!1,video:{width:{ideal:400},height:{ideal:300},frameRate:{ideal:30},facingMode:"user"}},faceScore:0,faceNum:0,tipText:"请确保正对手机，光线充足",photos:[],photoSleep:!1,cameraWork:!1,cameraLoading:!1,overtime:k,overtimer:null,currentDeg:0,stepEl:null,stepIndex:0,modelLoading:!1,dataLoading:!1,resultShow:!1,resultCode:4,buttonTime:g,demo:0,mediaChecking:!0,isAlipay:!1,videoSrc:"",agreement:!1,agreementShow:!1,agreementURL:"",compName:"",err1:"",err2:""}},mounted(){m=this,new p.a,this.$nextTick(()=>{this.fnInit()})},destroy(){this.fnClose()},watch:{currentDeg(e){if(m.photos.length>=E)return m.tipText="已完成",void setTimeout(()=>{m.fnClose()},100)},faceScore(e){if(m.photos.length>=E)clearInterval(m.overtimer);else switch(m.faceNum){case 0:if(!m.mediaDevice)break;m.tipText="请移动人脸到框内";break;case 1:m.mediaDevice&&(m.tipText=e>=T?"请保持姿势不变":"请正对手机，调整人脸与手机的距离"),e>=T&&!m.photoSleep&&m.photos.length<E&&(m.takePhoto(e),m.photoSleep=!0,setTimeout(()=>{m.photoSleep=!1},m.mediaDevice?Math.floor(501*Math.random()+300):100));break;default:if(!m.mediaDevice)break;m.tipText="请拍摄本人照片"}}},methods:{fnRun(){setTimeout(()=>{m.fnRunFaceLandmark()},300)},drawCircle(){let e=m.$refs.myCircle;m.stepEl=m.$refs.myStep;let t=300,i=400;window.devicePixelRatio&&(m.stepEl.style.width=e.style.width=t+"px",m.stepEl.style.height=e.style.height=i+"px",m.stepEl.height=e.height=i*window.devicePixelRatio,m.stepEl.width=e.width=t*window.devicePixelRatio,m.stepEl.getContext("2d").scale(window.devicePixelRatio,window.devicePixelRatio),e.getContext("2d").scale(window.devicePixelRatio,window.devicePixelRatio));let o=e.getContext("2d");o.fillStyle="#fff",o.arc(150,150,110,0,2*Math.PI,!1),o.arc(150,150,300,0,2*Math.PI,!0),o.fill(),m.drawStepRound()},drawStepRound(){let e=m.stepEl.getContext("2d");e.clearRect(0,0,m.stepEl.width,m.stepEl.height),e.beginPath(),e.lineWidth=4,e.strokeStyle="#ebebeb",e.lineCap="round",e.arc(150,150,114,Math.PI/180*(90+(360-w)/2),Math.PI/180*(450-(360-w)/2),!1),e.stroke()},colorToRgb(e){let t=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(e=e.toLowerCase(),e&&t.test(e)){if(4===e.length){let t="#";for(let i=1;i<4;i+=1)t+=e.slice(i,i+1).concat(e.slice(i,i+1));e=t}let t=[];for(let i=1;i<7;i+=2)t.push(parseInt("0x"+e.slice(i,i+2)));return t}return e},colorToHex(e){let t=e,i=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(/^(rgb|RGB)/.test(t)){let e=t.replace(/(?:\(|\)|rgb|RGB)*/g,"").split(","),i="#";for(let t=0;t<e.length;t++){let o=Number(e[t]).toString(16);o=o<10?"0"+o:o,"0"===o&&(o+=o),i+=o}return 7!==i.length&&(i=t),i}if(!i.test(t))return t;{let e=t.replace(/#/,"").split("");if(6===e.length)return t;if(3===e.length){let t="#";for(let i=0;i<e.length;i+=1)t+=e[i]+e[i];return t}}},getRandomRate(){let e=w%x?parseInt(w/x)+1:w/x;y=[];let t=0;for(let i=1;i<e;i++){let e=Math.floor(Math.random()*(x-2+1)+2);y.push(e),t+=e}y.push(w-t)},gradientColor(e,t,i){let o=m.colorToRgb(e),a=o[0],n=o[1],r=o[2],s=m.colorToRgb(t),c=s[0],d=s[1],l=s[2],h=(c-a)/i,u=(d-n)/i,v=(l-r)/i,f=[];for(let p=0;p<i;p++){let e=m.colorToHex("rgb("+parseInt(h*p+a)+","+parseInt(u*p+n)+","+parseInt(v*p+r)+")");f.push(e)}return f},async fnInit(){m.drawCircle(),b=m.gradientColor("#BFD9F3","#1989fa",w%x?parseInt(w/x)+1:w/x),m.getRandomRate(),console.log(v["nets"].tinyFaceDetector.getDefaultModelName());try{await v["nets"][m.nets].loadFromUri("./models")}catch(e){this.err1=e}try{await v["loadFaceLandmarkModel"]("./models")}catch(e){this.err2=e}m.options=new v["TinyFaceDetectorOptions"]({inputSize:224,scoreThreshold:.3}),m.videoEl=m.$refs.myVideo,m.canvasEl=m.$refs.myCanvas},async fnRunFaceLandmark(){if(m.videoEl.paused)return clearTimeout(m.timeout);const e=await v[m.detectFace](m.videoEl,m.options);e&&!m.videoEl.paused?(m.faceNum=e?e.length:0,m.faceScore=1===m.faceNum?e[0].score:0):m.canvasEl.getContext("2d").clearRect(0,0,m.canvasEl.width,m.canvasEl.height),m.timeout=setTimeout(()=>m.fnRunFaceLandmark(),150)},fnOpen(){"object"!==typeof window.stream&&(m.cameraLoading=!0,m.tipText="正在启动相机…",clearTimeout(m.timeout),m.timeout=setTimeout(()=>{navigator.mediaDevices.getUserMedia(m.constraints).then(m.fnSuccess).catch(m.fnError)},200))},fnSuccess(e){window.stream=e,m.videoEl.srcObject=e,m.videoEl.play(),setTimeout(()=>{m.cameraLoading=!1,m.cameraWork=!0,m.tipText="请移动人脸到框内"},100)},fnError(e){if(console.log(e.name),F++,m.cameraLoading=!1,F>2||"NotAllowedError"!=e.name)return alert("开启相机失败, 已切换至视频录制模式"),m.tipText="请确保正对手机，光线充足",m.mediaDevice=!1,void(m.resultCode=4);m.tipText="开启相机失败, 请重试",m.resultCode=2,m.resultShow=!0},fnClose(){m.canvasEl&&m.canvasEl.getContext("2d").clearRect(0,0,m.canvasEl.width,m.canvasEl.height),m.videoEl&&m.videoEl.pause(),m.cameraWork=!1,clearTimeout(m.timeout),"object"===typeof window.stream&&(window.stream.getTracks().forEach(e=>e.stop()),window.stream="",m.videoEl.srcObject=null)},takePhoto(e){let t=m.$refs.myPhoto,i=t.getContext("2d");i.drawImage(m.videoEl,0,0,m.videoEl.videoWidth,m.videoEl.videoHeight);let o=t.toDataURL("image/jpeg");m.photos.push({score:e,img:o})}}},S=C,R=(i("1fe1"),Object(r["a"])(S,h,u,!1,null,null,null)),P=R.exports,M=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",[i("div",{staticClass:"x-face-detect-modal"},[i("video",{ref:"video",staticStyle:{width:"300px",height:"300px"},attrs:{autoplay:""},on:{canplay:e.handleVideoCanPlay}}),i("canvas",{ref:"canvas",attrs:{width:e.width,height:e.height}}),i("img",{attrs:{src:e.imgSrc}}),i("button",{on:{click:e.toGetUserMedia}},[e._v("调用摄像头")])])])},O=[],j={name:"",data(){return{options:{},imgSrc:"",canPlay:"",canvas:"",video:"",stream:null,getUserMediaFail:"",width:300,height:300,boxWidth:300,boxHeight:300,viewFinderBox:{}}},created(){this.options=new v["TinyFaceDetectorOptions"]({scoreThreshold:.5})},mounted(){this.canvas=this.$refs["canvas"],this.video=this.$refs["video"],this.init(),this.$nextTick(()=>{this.initViewFinder()})},methods:{handleVideoCanPlay(){console.log("视频播放成功","handleVideoCanPlay"),this.canPlay=!0},async init(){await v["nets"].tinyFaceDetector.loadFromUri("../../public/models")},toGetUserMedia(){this.getUserMedia(e=>{this.stream=e,this.video&&(this.video["srcObject"]=e),console.log("获取视频成功",this.video["srcObject"])},e=>this.getUserMediaFail=!0)},getUserMedia(e,t){const i={video:{facingMode:"user",width:{ideal:this.width},height:{ideal:this.height}}};navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(i).then(e).catch(t):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(i,e,t):navigator.mozGetUserMedia?navigator.mozGetUserMedia(i,e,t):navigator.getUserMedia&&navigator.getUserMedia(i,e,t)},initViewFinder(){if(!this.video)return;const e=(this.video.videoWidth-this.boxWidth)/2,t=(this.video.videoHeight-this.boxHeight)/2;this.canvas&&(this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight),this.viewFinderBox={topLeft:{x:e,y:t},topRight:{x:e+this.boxWidth,y:t},bottomLeft:{x:e,y:t+this.boxHeight},bottomRight:{x:e+this.boxWidth,y:t+this.boxHeight}},console.log("初始化取景框",this.viewFinderBox)},drawViewFinder(){let e=null;this.canvas&&(e=this.canvas.getContext("2d"));const t=50;if(!e)return!1;e.clearRect(0,0,this.canvas?this.canvas.width:0,this.canvas?this.canvas.height:0);const i=this.video?(this.video.videoWidth-200)/2:200;e.font="20px Arial",e.fillText("请保持脸部在取景框内",i,50);const o=Object.keys(this.viewFinderBox);o.forEach(i=>{const o=this.viewFinderBox[i];if(o)switch(e.moveTo(o.x,o.y),i){case"topLeft":e.lineTo(o.x+t,o.y),e.moveTo(o.x,o.y),e.lineTo(o.x,o.y+t);break;case"topRight":e.lineTo(o.x-t,o.y),e.moveTo(o.x,o.y),e.lineTo(o.x,o.y+t);break;case"bottomLeft":e.lineTo(o.x+t,o.y),e.moveTo(o.x,o.y),e.lineTo(o.x,o.y-t);break;case"bottomRight":e.lineTo(o.x-t,o.y),e.moveTo(o.x,o.y),e.lineTo(o.x,o.y-t);break;default:break}}),e.lineWidth=2,e.strokeStyle="white",e.stroke()},delay(){for(let e=0;e<2e5;e++);return""},async detectFace(){if(await new Promise(e=>requestAnimationFrame(e)),this.drawViewFinder(),!this.canvas||!this.video||!this.video.currentTime||this.video.paused||this.video.ended)return this.detectFace();const e=await Object(v["detectSingleFace"])(this.video,this.options);if(!e)return this.detectFace();const t=Object(v["matchDimensions"])(this.canvas,this.video,!0),i=Object(v["resizeResults"])(e,t),o=i.box;if(!this.checkInViewFinder(o))return this.detectFace();this.drawViewFinder(),this.drawBox(o,"识别中"),this.video.pause();const a=await this.cameraShoot(this.video,i.box.topLeft,i.box.width,i.box.height);if(!a)return this.drawBox(o,"识别失败"),await delay(1e3),this.video.play(),this.detectFace();let n=new window.File([a],"人脸头像.jpeg",{type:"image/jpeg"});const r=await this.computedService.faceDetect(this.formId,n);if(!r)return this.drawBox(o,"识别失败"),await delay(1e3),this.video.play(),this.detectFace();this.handleStopVideo()},cameraShoot(e,t,i,o){const a=document.createElement("canvas");return a.width=e.videoWidth,a.height=e.videoHeight,a.getContext("2d")&&a.getContext("2d").drawImage(e,t.x-40,t.y-40,i+80,o+80,0,0,a.width,a.height),new Promise(e=>a.toBlob(e,"image/jpeg"))},drawBox(e,t){if(!this.canvas)return;const i=this.canvas.getContext("2d");i&&i.clearRect(e.x,e.y,e.width,e.height);const o=new v["draw"].DrawBox(e,{label:t});o.draw(this.canvas)},handleStopVideo(){this.stream&&this.stream.getTracks().forEach(e=>e.stop())}}},_=j,D=(i("61e5"),Object(r["a"])(_,M,O,!1,null,"c5c55d00",null)),U=D.exports,L=[{path:"/",name:"人脸提取",component:P},{path:"/two",name:"two",component:U}];o["a"].use(l["a"]);const I=new l["a"]({routes:L});I.beforeEach((e,t,i)=>{i()}),I.afterEach(()=>{window.scrollTo(0,0)});var $=I;o["a"].config.productionTip=!1,new o["a"]({router:$,render:e=>e(d)}).$mount("#app")},"58f1":function(e,t,i){},"61e5":function(e,t,i){"use strict";i("8fb2")},"85ec":function(e,t,i){},"8fb2":function(e,t,i){}});